<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perp Trading Calculator</title>
  <style>
    :root{
      --bg:#0b1628; --panel:#0f1f39; --panel-2:#102544; --text:#e7eefc; --muted:#9fb3d9;
      --accent:#2a66ff; --accent-2:#39b17a; --border:#334e7e; --chip:#142a57; --green:#39b17a;
      --orange:#f6c062; --purple:#7c5cff; --purple-2:#6547ff;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:"Segoe UI",Roboto,system-ui,-apple-system,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background: radial-gradient(1200px 800px at 20% -10%, #142b54 0%, transparent 60%),
                  radial-gradient(1200px 800px at 120% 120%, #13305f 0%, transparent 50%),
                  var(--bg);
      color:var(--text); padding:24px 16px 80px; line-height:1.45;
    }
    .wrap{max-width:1120px;margin:0 auto}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .brand h1{margin:0;font-size:22px;font-weight:800}
    .brand .desc{color:var(--muted);font-size:13px;margin-top:4px}
    .top-actions{display:flex;gap:10px;align-items:center}
    .plan-badge{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1b34;color:#bfe8d3}

    .btn{border:1px solid transparent;border-radius:12px;padding:10px 12px;font-weight:750;letter-spacing:.2px;cursor:pointer;color:white}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent)} .btn.primary:hover{filter:brightness(1.05)}
    .btn.success{background:var(--accent-2)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.archive{background:#1a2b52;border:1px solid #3b5aa1}
    .btn.edit{background:#0b1e3a;border:1px solid #325a97;color:#cfe0ff}
    .btn.tps{background:#13204a;border:1px solid #3e3aa1}
    .btn.tps.active{background:var(--purple);border-color:var(--purple-2)}
    .btn.close{background:#102a22;border:1px solid #1f644e;color:#aef0d1}
    .btn.cancel{background:#6c757d}

    /* AUTH gate */
    #authGate{max-width:420px;margin:40px auto;background:#0f1f39;border:1px solid #334e7e;border-radius:14px;padding:18px;display:none}
    #authGate input{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0c1b34;color:#e7eefc;font-weight:600}

    /* LIVE */
    .live-area{margin:0 auto 18px;position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(13,26,49,.75) 0%,rgba(13,26,49,.35) 100%);
      backdrop-filter:blur(4px);border:1px solid var(--border);border-radius:16px;padding:12px}
    .live-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;color:#bfe8d3;font-weight:800}
    .live-dot{width:12px;height:12px;border-radius:999px;background:var(--green);box-shadow:0 0 0 0 rgba(57,177,122,.5);animation:dotPulse 1.6s ease-in-out infinite}
    @keyframes dotPulse{0%{box-shadow:0 0 0 0 rgba(57,177,122,.55)}50%{box-shadow:0 0 0 8px rgba(57,177,122,0)}100%{box-shadow:0 0 0 0 rgba(57,177,122,0)}}
    .live-list{display:grid;grid-template-columns:1fr;gap:10px} @media (min-width:900px){.live-list{grid-template-columns:1fr 1fr 1fr}}
    .live-card{border:1px solid rgba(57,177,122,.45);background:linear-gradient(180deg,rgba(57,177,122,.12) 0%,rgba(57,177,122,.06) 100%);border-radius:18px;padding:12px}
    .live-card-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
    .live-id{display:flex;align-items:center;gap:10px;font-weight:800;font-size:12px;color:#c9f1dd}
    .live-id .badge{padding:4px 10px;border-radius:999px;border:1px solid rgba(57,177,122,.4);background:rgba(57,177,122,.12)}
    .live-kv{font-size:12px;color:#dff6eb} .live-kv b{color:#b9e9cd}

    /* MAIN GRID */
    .shell{display:grid;grid-template-columns:1fr;gap:20px}
    @media (min-width:1060px){.shell{grid-template-columns:520px 1fr}}
    .card{background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);border:1px solid var(--border);border-radius:14px}
    .card .inner{padding:20px}
    label{display:block;font-weight:650;margin:14px 0 6px;color:var(--muted)}
    input[type="number"],input[type="text"],input[type="email"],input[type="password"],select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);outline:none;background:#0c1b34;color:#e7eefc;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .results{background:#0c1b34;border:1px dashed var(--border);border-radius:12px;padding:14px;margin-top:14px}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
    .kpi .box{background:#0e2041;border:1px solid var(--border);border-radius:10px;padding:10px}
    .kpi .title{font-size:12px;color:var(--muted);font-weight:800;margin-bottom:4px}
    .kpi .value{font-size:16px;font-weight:800}
    .separator{height:1px;background:var(--border);margin:14px 0}
    small.note{color:#8aa2cf}

    /* History + Stats */
    .hist-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .hist-title{font-weight:800}
    .hist-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .stat{display:flex;gap:6px;align-items:center;background:#0b1e3a;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
    .stat .label{font-size:12px;color:#9fb3d9;font-weight:800}.stat .value{font-size:13px;font-weight:900}
    .pl.pos{color:#6ee7b7}.pl.neg{color:#f7a6a3}.pl.zero{color:#c8d3ea}.sr{color:var(--orange)} .fees{color:#dbe7ff}
    .hist-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:10px;max-height:540px;overflow:auto}
    .hist-item{background:#0c1b34;border:1px solid var(--border);border-radius:10px;padding:12px;position:relative}
    .hist-top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
    .pill{font-weight:800;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--chip)}
    .muted{color:#9fb3d9;font-size:12px} .labels b{color:#b9c8e8;font-weight:800}
    .trash{border:none;background:transparent;cursor:pointer;font-size:18px;line-height:1;color:#ffb3b1;padding:6px 8px;border-radius:8px}
    .trash:hover{background:rgba(217,83,79,.12)}
    .btn.view{ background:#0e2041;border:1px solid #3a5288; color:#cfe0ff; padding:8px 10px; border-radius:10px; font-weight:800; }

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex}
    .modal-card{width:100%;max-width:680px;background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);border:1px solid var(--border);border-radius:14px}
    .modal-card .inner{padding:18px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .pnl{font-weight:900}.pnl.pos{color:#6ee7b7}.pnl.neg{color:#f7a6a3}

    /* Archive */
    .archive-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .archive-controls{display:flex;gap:10px;align-items:center}
    .select{background:#0c1b34;border:1px solid var(--border);border-radius:10px;color:#e7eefc;padding:8px 10px;font-weight:700}
    .month-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .m-btn{padding:10px;border-radius:10px;border:1px solid var(--border);background:#0c1b34;color:#e7eefc;font-weight:800;cursor:pointer}
    .m-btn[disabled]{opacity:.35;cursor:not-allowed}
    .m-btn.active{outline:2px solid var(--accent)}
    .m-count{font-size:11px;color:#9fb3d9;margin-left:6px}
    .archive-stats{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .archive-list{max-height:520px;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .toast{position:fixed;bottom:20px;right:20px;background:#0e2041;border:1px solid var(--border);color:#e7eefc;border-radius:12px;padding:12px 14px;opacity:0;transform:translateY(8px);transition:all .25s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <!-- AUTH GATE -->
  <div id="authGate">
    <h2 style="margin:0 0 10px">Sign in</h2>
    <div id="authError" style="color:#ff9b9b;margin-bottom:8px;display:none"></div>
    <label>Email</label>
    <input type="email" id="authEmail" placeholder="you@example.com">
    <label style="margin-top:8px">Password</label>
    <input type="password" id="authPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn primary">Login</button>
      <button id="btnRegister" class="btn ghost">Create account</button>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" style="display:none">
    <div class="topbar">
      <div class="brand">
        <h1>Perp Trading Calculator</h1>
        <div class="desc">Position size, Live tracking, TPs, History & Archive</div>
      </div>
      <div class="top-actions">
        <div class="plan-badge" id="planBadge">Plan: Free</div>
        <button class="btn archive" id="openArchive">Archive</button>
        <button class="btn ghost" id="openProfile">Profile</button>
      </div>
    </div>

    <!-- LIVE -->
    <div class="live-area">
      <div class="live-head"><div class="live-dot"></div><div>Live</div></div>
      <div class="live-list" id="liveList"></div>
    </div>

    <div class="shell">
      <!-- LEFT: Calculator -->
      <div class="card">
        <div class="inner">
          <p class="desc">Compute position size (BTC &amp; USDT), margin and leverage. Put a trade in <b>Live</b> or save it.</p>

          <label for="wallet">Wallet amount (USDT)</label>
          <input type="number" id="wallet" placeholder="e.g., 1000" step="any" />

          <div class="row">
            <div>
              <label for="risk">Risk (% of wallet)</label>
              <input type="number" id="risk" placeholder="e.g., 5" step="any" />
            </div>
            <div>
              <label for="margin">Margin (% of wallet)</label>
              <input type="number" id="margin" placeholder="e.g., 75" step="any" value="75"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="entry">Entry price (USDT)</label>
              <input type="number" id="entry" placeholder="e.g., 100000" step="any" />
            </div>
            <div>
              <label for="stop">Stop loss (USDT)</label>
              <input type="number" id="stop" placeholder="e.g., 99000" step="any" />
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="calcBtn">Calculate</button>
            <button class="btn success" id="liveBtn" hidden>Live</button>
            <button class="btn success" id="saveBtn" hidden>Save Calculation</button>
            <button class="btn ghost" id="clearBtn">Clear all</button>
          </div>

          <div class="results" id="results" hidden>
            <div class="kpi">
              <div class="box">
                <div class="title">Risk amount</div>
                <div class="value"><span id="riskUSDT">-</span> USDT</div>
              </div>
              <div class="box">
                <div class="title">Used margin</div>
                <div class="value"><span id="marginUSDT">-</span> USDT</div>
              </div>
            </div>
            <div class="kpi">
              <div class="box">
                <div class="title">Position size</div>
                <div class="value"><span id="posBTC">-</span> BTC ‚Ä¢ <span id="posUSDT">-</span> USDT</div>
              </div>
              <div class="box">
                <div class="title">Required leverage</div>
                <div class="value"><span id="lev">-</span>x</div>
              </div>
            </div>
            <div class="separator"></div>
            <small class="note">For informational purposes only. Not financial advice.</small>
          </div>
        </div>
      </div>

      <!-- RIGHT: History + Stats -->
      <div class="card">
        <div class="inner">
          <div class="hist-header">
            <div class="hist-title">Calculation History</div>
            <div class="hist-controls">
              <div class="stat"><span class="label">SR</span> <span class="value sr" id="srStat">‚Äî</span></div>
              <div class="stat"><span class="label">Total P/L</span> <span class="value pl zero" id="plStat">0.00</span></div>
              <div class="stat"><span class="label">Total Fees</span> <span class="value fees" id="feesStat">0.00</span></div>
              <button class="btn archive" id="exportBtn">Export</button>
            </div>
          </div>
          <ul class="hist-list" id="historyList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Account</h3>
      <div id="accountEmail" class="muted" style="margin-bottom:10px">‚Äî</div>
      <div class="hist-item" style="margin-bottom:10px">
        <div class="muted"><b>Status:</b> <span id="subStatus">Free</span></div>
        <div class="muted"><b>Valid until:</b> <span id="subUntil">‚Äî</span></div>
      </div>
      <label for="redeemKey">Enter your authentication key</label>
      <input id="redeemKey" placeholder="KEY-XXXX-XXXX-XXXX">
      <div class="modal-actions" style="justify-content:flex-start">
        <button class="btn primary" id="btnRedeem">Redeem</button>
        <div id="redeemMsg" class="muted" style="margin-left:8px"></div>
      </div>
      <div class="separator"></div>
      <div class="muted">
        Don‚Äôt have an authentication key?
        Contact <a href="https://t.me/alwkeb" target="_blank">@alwkeb</a> on Telegram to get yours.
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnLogout">Log out</button>
        <button class="btn cancel" id="closeProfile">Close</button>
      </div>
    </div></div>
  </div>

  <!-- Pair Modal -->
  <div class="modal" id="pairModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Select pair</h3>
      <label for="pairSelect">Trading pair</label>
      <select id="pairSelect"></select>
      <div id="customPairWrap" style="display:none;margin-top:10px">
        <label for="customPair">New pair</label>
        <input type="text" id="customPair" placeholder="e.g., XRPUSDT" />
      </div>
      <div class="modal-actions">
        <button class="btn cancel" id="cancelPair">Cancel</button>
        <button class="btn primary" id="confirmPair">Confirm</button>
      </div>
    </div></div>
  </div>

  <!-- Close Live Modal -->
  <div class="modal" id="closeModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Close Live trade</h3>
      <div class="muted" style="margin-bottom:6px">Select W/L, enter Closed price and Net P/L (USDT) then ‚ÄúSave to History‚Äù.</div>
      <div style="display:flex;gap:18px;align-items:center;margin-bottom:8px">
        <label><input type="radio" name="wl" id="optW" /> Win</label>
        <label><input type="radio" name="wl" id="optL" /> Loss</label>
      </div>
      <div class="row">
        <div>
          <label for="closePrice">Closed price</label>
          <input type="number" id="closePrice" placeholder="e.g., 101200" step="any" />
        </div>
        <div>
          <label for="netAmount">Net P/L (USDT)</label>
          <input type="number" id="netAmount" placeholder="e.g., 130 or -130" step="any" />
        </div>
      </div>
      <div class="separator"></div>
      <div class="muted" id="grossLine"></div>
      <div class="muted" style="margin-top:6px">
        <b>Estimated fees</b> (Gross ‚àí Net) : <span id="feesCalc" class="pnl">‚Äî</span>
      </div>
      <div class="modal-actions">
        <button class="btn cancel" id="cancelClose">Close</button>
        <button class="btn primary" id="saveClosed">Save to History</button>
      </div>
    </div></div>
  </div>

  <!-- Edit Live Modal -->
  <div class="modal" id="editLiveModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Edit Live trade</h3>
      <div class="row">
        <div>
          <label for="editEntry">Entry price</label>
          <input type="number" id="editEntry" step="any" />
        </div>
        <div>
          <label for="editStop">Stop loss</label>
          <input type="number" id="editStop" step="any" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn cancel" id="cancelEdit">Cancel</button>
        <button class="btn primary" id="saveEdit">Save</button>
      </div>
    </div></div>
  </div>

  <!-- TP Modal (edit/apply) -->
  <div class="modal" id="tpModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Partial Take-Profits (TPs)</h3>
      <div class="muted" id="tpRemainHelp">Remaining closable: ‚Äî%</div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="tpPct">Close % of current position</label>
          <input type="number" id="tpPct" placeholder="e.g., 20" step="any" />
        </div>
        <div>
          <label for="tpPrice">TP price</label>
          <input type="number" id="tpPrice" placeholder="e.g., 102000" step="any" />
        </div>
      </div>
      <div class="muted" id="tpPreview" style="margin-top:8px">Secured profit preview: ‚Äî</div>
      <div id="tpListBox" style="margin-top:10px"></div>
      <div class="modal-actions">
        <button class="btn cancel" id="cancelTp">Cancel</button>
        <button class="btn primary" id="applyTp">Apply TP</button>
      </div>
    </div></div>
  </div>

  <!-- TP View Modal (history/archive view only) -->
  <div class="modal" id="tpViewModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Partial TPs (view only)</h3>
      <div id="tpViewList"></div>
      <div class="modal-actions"><button class="btn cancel" id="closeTpView">Close</button></div>
    </div></div>
  </div>

  <!-- Export confirm -->
  <div class="modal" id="exportModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Move all History to Archive?</h3>
      <div class="muted">This will transfer every trade currently in <b>History</b> to <b>Archive</b> and remove them from History.</div>
      <div class="modal-actions">
        <button class="btn cancel" id="cancelExport">Cancel</button>
        <button class="btn primary" id="proceedExport">Proceed</button>
      </div>
    </div></div>
  </div>

  <!-- Archive Modal -->
  <div class="modal" id="archiveModal" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <div class="archive-head">
        <h3 style="margin:0">Archive</h3>
        <div class="archive-controls">
          <label for="yearSelect" class="muted" style="font-weight:800">Year</label>
          <select id="yearSelect" class="select"></select>
          <button class="btn cancel" id="closeArchive">Close</button>
        </div>
      </div>
      <div class="month-grid" id="monthGrid"></div>
      <div class="archive-stats" id="archiveStats" style="display:none">
        <div class="stat"><span class="label">SR</span> <span class="value sr" id="archSR">‚Äî</span></div>
        <div class="stat"><span class="label">P&amp;L</span> <span class="value" id="archPL">0.00</span></div>
        <div class="stat"><span class="label">Wallet Growth</span> <span class="value" id="archGrowth">‚Äî</span></div>
      </div>
      <div class="archive-list" id="archiveList"></div>
      <div class="muted" style="margin-top:6px">Grouping is by <b>closing date</b>. Trades without a close date use their saved date.</div>
    </div></div>
  </div>

  <!-- Archive delete flow -->
  <div class="modal" id="archDel1" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Delete this trade?</h3>
      <div class="muted">Are you sure you want to delete this trade from the Archive?</div>
      <div class="modal-actions">
        <button class="btn cancel" id="archDel1Cancel">Cancel</button>
        <button class="btn primary" id="archDel1Yes">Yes</button>
      </div>
    </div></div>
  </div>
  <div class="modal" id="archDel2" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px;color:#ffdfe0">Permanent delete</h3>
      <div class="muted">This trade will be <b>permanently deleted</b> and cannot be recovered.</div>
      <div class="modal-actions">
        <button class="btn cancel" id="archDel2Cancel">Cancel</button>
        <button class="btn" id="archDel2Delete" style="background:#5a1c1c;border:1px solid #9c3b3b">Delete Trade</button>
      </div>
    </div></div>
  </div>
  <div class="modal" id="archDelOk" aria-hidden="true">
    <div class="modal-card"><div class="inner">
      <h3 style="margin:0 0 12px">Trade successfully deleted</h3>
      <div class="modal-actions"><button class="btn primary" id="archDelOkClose">Close</button></div>
    </div></div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase (Step 7) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    /* Replace with your Web App config from Firebase Console (</> Add app) */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>

  <!-- App Logic -->
  <script>
    /* ---------------- Utils & Storage ---------------- */
    const el = id => document.getElementById(id);
    const toast = (m)=>{ const t=el("toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1600); };
    function fmt(n,d=2){ const num=Number(n); if(!isFinite(num)) return "-"; return num.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}); }
    const TRADES_KEY="savedTrades_v2", LIVE_KEY="liveTrades_v1", ARCHIVE_KEY="archivedTrades_v1", PAIRS_KEY="savedPairs";

    const Cloud = { uid:null, docRef:null, _timer:null,
      pushLocalToCloud(){
        if(!this.docRef) return;
        clearTimeout(this._timer);
        this._timer=setTimeout(async ()=>{
          const payload={
            pairs: JSON.parse(localStorage.getItem(PAIRS_KEY) || "[]"),
            live: JSON.parse(localStorage.getItem(LIVE_KEY) || "[]"),
            trades: JSON.parse(localStorage.getItem(TRADES_KEY) || "[]"),
            archive: JSON.parse(localStorage.getItem(ARCHIVE_KEY) || "[]"),
            updatedAt: Date.now()
          };
          await this.docRef.set(payload,{merge:true});
        },250);
      }
    };
    const _setItem = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){ _setItem(k,v);
      if([PAIRS_KEY,LIVE_KEY,TRADES_KEY,ARCHIVE_KEY].includes(k) && Cloud.docRef){ Cloud.pushLocalToCloud(); }
    };
    const getLives=()=>JSON.parse(localStorage.getItem(LIVE_KEY)||"[]");
    const setLives=(a)=>localStorage.setItem(LIVE_KEY,JSON.stringify(a));
    const getTrades=()=>JSON.parse(localStorage.getItem(TRADES_KEY)||"[]");
    const setTrades=(a)=>localStorage.setItem(TRADES_KEY,JSON.stringify(a));
    const getArchive=()=>JSON.parse(localStorage.getItem(ARCHIVE_KEY)||"[]");
    const setArchive=(a)=>localStorage.setItem(ARCHIVE_KEY,JSON.stringify(a));

    function nowIso(){ return new Date().toISOString(); }
    function monthNames(){ return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; }
    function diffToDHm(startIso, endIso){
      const s=new Date(startIso), e=new Date(endIso); let ms=Math.max(0,e-s);
      const days=Math.floor(ms/86400000); ms-=days*86400000;
      const h=Math.floor(ms/3600000); ms-=h*3600000;
      const m=Math.floor(ms/60000);
      return `${days}d ${h}h ${m}m`;
    }

    /* ---------------- Auth Gate ---------------- */
    const gate = el('authGate'), appWrap=document.querySelector('.wrap'), errBox=el('authError');
    const showAuth=(b)=>{ gate.style.display=b?'block':'none'; appWrap.style.display=b?'none':'block'; };
    el('btnLogin').onclick = async ()=>{
      errBox.style.display='none';
      try{ await auth.signInWithEmailAndPassword(el('authEmail').value.trim(), el('authPass').value); }
      catch(e){ errBox.textContent=e.message; errBox.style.display='block'; }
    };
    el('btnRegister').onclick = async ()=>{
      errBox.style.display='none';
      try{ await auth.createUserWithEmailAndPassword(el('authEmail').value.trim(), el('authPass').value); }
      catch(e){ errBox.textContent=e.message; errBox.style.display='block'; }
    };

    /* ---------------- Plan gating ---------------- */
    let isPro=false, validUntil=null, freeCalcCount=0;
    function setPlanBadge(){ el('planBadge').textContent = `Plan: ${isPro? 'Pro' : 'Free'}${isPro && validUntil ? ` (until ${validUntil.toLocaleDateString()})` : ''}`; }
    async function loadSubscription(uid){
      const ref=db.doc(`users/${uid}/subscription/current`); const s=await ref.get();
      isPro=false; validUntil=null;
      if(s.exists){ const d=s.data(); if(d.validUntil && d.validUntil.toDate()>new Date()){ isPro=true; validUntil=d.validUntil.toDate(); } }
      updateUiForPlan();
      el('subStatus') && (el('subStatus').textContent = isPro?'Pro':'Free');
      el('subUntil') && (el('subUntil').textContent  = isPro? validUntil.toLocaleString() : '‚Äî');
      setPlanBadge();
    }
    async function loadMeta(uid){
      const ref=db.doc(`users/${uid}/meta/limits`); const s=await ref.get();
      freeCalcCount=(s.exists && typeof s.data().calcCount==='number')? s.data().calcCount:0;
    }
    async function incCalcCount(uid){
      const ref=db.doc(`users/${uid}/meta/limits`);
      await db.runTransaction(async tx=>{
        const s=await tx.get(ref); const cur=s.exists?(s.data().calcCount||0):0;
        tx.set(ref,{calcCount:cur+1},{merge:true});
      });
      freeCalcCount+=1;
    }
    function updateUiForPlan(){
      ['saveBtn','liveBtn','exportBtn','openArchive'].forEach(id=>{ const b=el(id); if(!b) return; b.disabled=!isPro; });
    }

    /* ---------------- Profile modal ---------------- */
    const profileModal=el('profileModal');
    el('openProfile').onclick=()=> profileModal.classList.add('open');
    el('closeProfile').onclick=()=> profileModal.classList.remove('open');
    el('btnLogout').onclick=()=> auth.signOut();
    el('btnRedeem').onclick = async ()=>{
      const key=(el('redeemKey').value||'').trim(); const msg=el('redeemMsg'); msg.textContent='Checking...';
      try{
        const user=auth.currentUser; const idToken=await user.getIdToken();
        const res=await fetch('/.netlify/functions/redeem',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+idToken},body:JSON.stringify({key})});
        const data=await res.json();
        if(!res.ok){ msg.textContent=data.error||'Invalid key.'; return; }
        msg.textContent='Key applied.';
        await loadSubscription(user.uid); updateUiForPlan(); setPlanBadge();
      }catch(e){ msg.textContent=e.message||'Redeem failed.'; }
    };

    /* ---------------- Pairs ---------------- */
    function loadPairs(){
      let pairs = JSON.parse(localStorage.getItem(PAIRS_KEY) || "null");
      if(!Array.isArray(pairs) || pairs.length===0) pairs = ["BTCUSDT","ETHUSDT","Other‚Ä¶"];
      else { pairs = pairs.filter(p=>p!=="Other‚Ä¶" && p!=="Autre‚Ä¶"); pairs.push("Other‚Ä¶"); }
      localStorage.setItem(PAIRS_KEY, JSON.stringify(pairs));
      const sel = el("pairSelect"); sel.innerHTML = "";
      pairs.forEach(p=>{ const o=document.createElement("option"); o.value=p; o.textContent=p; sel.appendChild(o); });
    }

    /* ---------------- Calculator ---------------- */
    let currentCalc=null, liveToAdd=null, closingLiveId=null, editingLiveId=null, tpLiveId=null;

    el("calcBtn").addEventListener("click", async ()=>{
      const user=auth.currentUser; if(!user){ alert("Please login."); return; }
      if(!isPro && freeCalcCount>=5){ alert("Free tier limit reached (5 calculations). Enter an authentication key in Profile to unlock full access."); return; }

      const wallet=parseFloat(el('wallet').value), riskPct=parseFloat(el('risk').value),
            marginPct=parseFloat(el('margin').value), entry=parseFloat(el('entry').value), stop=parseFloat(el('stop').value);

      el("results").hidden = true; el("saveBtn").hidden = true; el("liveBtn").hidden = true;

      if([wallet,riskPct,marginPct,entry,stop].some(v=>!isFinite(v)) || wallet<=0 || entry<=0 || stop<=0 || marginPct<=0){
        alert("Please fill all fields with valid values."); return;
      }
      const riskUSDT = wallet*(riskPct/100);
      const priceDiff = Math.abs(entry - stop); if(priceDiff===0){ alert("Entry and stop must be different."); return; }
      const qtyBTC = riskUSDT / priceDiff;
      const marginUSDT = wallet*(marginPct/100);
      const notionalUSDT = entry * qtyBTC;
      let lev = Math.round(notionalUSDT / marginUSDT); if(lev<1) lev=1;

      el('riskUSDT').textContent=fmt(riskUSDT,2);
      el('marginUSDT').textContent=fmt(marginUSDT,2);
      el('posBTC').textContent=fmt(qtyBTC,6);
      el('posUSDT').textContent=fmt(notionalUSDT,2);
      el('lev').textContent=String(lev);
      el('results').hidden=false;
      el('saveBtn').hidden=false;
      el('liveBtn').hidden=false;

      currentCalc = {
        id: Date.now().toString(36)+Math.random().toString(36).slice(2,8),
        direction: "Long",
        wallet: Number(wallet.toFixed(2)),
        riskPercent: Number(riskPct),
        marginPercent: Number(marginPct),
        entryPrice: Number(entry.toFixed(2)),
        stopPrice: Number(stop.toFixed(2)),
        riskAmount: Number(riskUSDT.toFixed(2)),
        quantityBTC: Number(qtyBTC.toFixed(6)),
        notionalUSDT: Number(notionalUSDT.toFixed(2)),
        marginAmount: Number(marginUSDT.toFixed(2)),
        leverage: lev,
        ts: nowIso(),
        pair: null,
        outcome:null, closePrice:null, netProfit:null, totalFees:null,
        open_ts:null, close_ts:null, duration:null,
        tpList:[], tpSecured:0, tpPct:0
      };

      if(!isPro){ await incCalcCount(user.uid); setPlanBadge(); }
    });

    el("clearBtn").addEventListener("click", ()=>{ ["wallet","risk","margin","entry","stop"].forEach(id=>el(id).value=""); el("results").hidden=true; el("saveBtn").hidden=true; el("liveBtn").hidden=true; currentCalc=null; });

    // Save & Live require PRO
    el("saveBtn").addEventListener("click", ()=>{
      if(!isPro){ alert("Pro only. Redeem key in Profile."); return; }
      if(!currentCalc) return; liveToAdd = { mode:"save" }; loadPairs(); showModal(el("pairModal"), true);
    });
    el("liveBtn").addEventListener("click", ()=>{
      if(!isPro){ alert("Pro only. Redeem key in Profile."); return; }
      if(!currentCalc) return;
      if(getLives().length >= 3){ alert("Limit reached: 3 Live trades. Please close one to add another."); return; }
      liveToAdd = { mode:"live" }; loadPairs(); showModal(el("pairModal"), true);
    });

    /* ---------------- Pair modal ---------------- */
    function showModal(m, show){ m.classList.toggle("open", !!show); m.setAttribute("aria-hidden", show? "false":"true"); }
    el("pairSelect").addEventListener("change", (e)=>{
      const v = e.target.value; el("customPairWrap").style.display = (v==="Other‚Ä¶")? "block":"none"; if(v==="Other‚Ä¶") el("customPair").focus();
    });
    el("cancelPair").addEventListener("click", ()=> showModal(el("pairModal"), false));
    el("confirmPair").addEventListener("click", ()=>{
      if(!currentCalc || !liveToAdd){ showModal(el("pairModal"), false); return; }
      let pairFinal = el("pairSelect").value;
      if(pairFinal === "Other‚Ä¶"){
        const custom = (el("customPair").value || "").toUpperCase().trim();
        if(!custom.match(/^[A-Z0-9]{3,15}$/)){ alert("Please enter a valid pair (e.g., XRPUSDT)."); return; }
        pairFinal = custom;
        let pairs = JSON.parse(localStorage.getItem(PAIRS_KEY) || "[]");
        pairs = pairs.filter(p=>p!=="Other‚Ä¶");
        if(!pairs.includes(pairFinal)) pairs.unshift(pairFinal);
        pairs.push("Other‚Ä¶");
        localStorage.setItem(PAIRS_KEY, JSON.stringify(pairs));
      }
      currentCalc.pair = pairFinal;

      if(liveToAdd.mode === "save"){
        const arr = getTrades(); arr.push({...currentCalc}); setTrades(arr);
        currentCalc=null; el("saveBtn").hidden=true; el("liveBtn").hidden=true;
        renderHistory(); showModal(el("pairModal"), false); toast("Saved to History");
      }else{
        const lives = getLives(); const liveObj = { ...currentCalc, open_ts: nowIso() };
        lives.push(liveObj); setLives(lives);
        currentCalc=null; el("saveBtn").hidden=true; el("liveBtn").hidden=true;
        renderLive(); showModal(el("pairModal"), false); toast("Added to Live");
      }
      liveToAdd = null;
    });

    /* ---------------- Close Live ---------------- */
    function computeGrossPnl(t, closePrice){ return (closePrice - t.entryPrice) * t.quantityBTC; } // long-only
    function recomputeClosePreview(){
      const t = getLives().find(x=>x.id===closingLiveId);
      const cp = parseFloat(el("closePrice").value);
      const net = parseFloat(el("netAmount").value);
      if(!t || !isFinite(cp)){ el("feesCalc").textContent="‚Äî"; el("feesCalc").className="pnl"; el("grossLine").textContent=""; return; }
      const gross = computeGrossPnl(t, cp);
      el("grossLine").textContent = `Estimated gross PnL: ${fmt(gross,2)} USDT = (Close ‚àí Entry) √ó Size (BTC)`;
      if(!isFinite(net)){ el("feesCalc").textContent="‚Äî"; el("feesCalc").className="pnl"; return; }
      const fees = gross - net;
      el("feesCalc").textContent = `${fees>=0? "":"-"}${fmt(Math.abs(fees),2)} USDT`;
      el("feesCalc").className = "pnl " + (fees>=0? "neg":"pos");
    }
    el("closePrice").addEventListener("input", recomputeClosePreview);
    el("netAmount").addEventListener("input",  recomputeClosePreview);

    el("cancelClose").addEventListener("click", ()=> showModal(el("closeModal"), false));
    el("saveClosed").addEventListener("click", ()=>{
      const lives = getLives();
      const idx = lives.findIndex(x=>x.id===closingLiveId);
      if(idx<0){ showModal(el("closeModal"), false); return; }
      const t = lives[idx];

      const isW = el("optW").checked, isL = el("optL").checked;
      if(!isW && !isL){ alert("Choose Win or Loss."); return; }

      const cp = parseFloat(el("closePrice").value);
      const net = parseFloat(el("netAmount").value);
      if(!isFinite(cp)){ alert("Enter a valid Closed price."); return; }
      if(!isFinite(net)){ alert("Enter a valid Net P/L (USDT)."); return; }

      const gross = computeGrossPnl(t, cp);
      const fees  = gross - net;
      const close_ts = nowIso();
      const duration = diffToDHm(t.open_ts, close_ts);

      const saved = getTrades();
      saved.push({
        ...t,
        ts: close_ts,
        closePrice: Number(cp.toFixed(2)),
        outcome: isW ? "W" : "L",
        netProfit: Number(net.toFixed(2)),
        totalFees: Number(fees.toFixed(2)),
        close_ts,
        duration
      });
      setTrades(saved);

      lives.splice(idx,1); setLives(lives);
      showModal(el("closeModal"), false);
      renderLive(); renderHistory();
      toast("Trade saved to History");
      el("optW").checked=false; el("optL").checked=false; el("closePrice").value=""; el("netAmount").value="";
      el("feesCalc").textContent="‚Äî"; el("grossLine").textContent="";
      closingLiveId = null;
    });

    /* ---------------- Edit Live ---------------- */
    el("saveEdit").addEventListener("click", ()=>{
      const lives = getLives();
      const idx = lives.findIndex(x=>x.id===editingLiveId);
      if(idx<0){ showModal(el("editLiveModal"), false); return; }
      const t = lives[idx];
      const newEntry = parseFloat(el("editEntry").value);
      const newStop  = parseFloat(el("editStop").value);
      if(!isFinite(newEntry) || newEntry<=0 || !isFinite(newStop) || newStop<=0){ alert("Please enter valid Entry and Stop values."); return; }
      t.entryPrice = Number(newEntry.toFixed(2));
      t.stopPrice  = Number(newStop.toFixed(2));
      t.notionalUSDT = Number((t.entryPrice * t.quantityBTC).toFixed(2));
      let lev = t.notionalUSDT / t.marginAmount; t.leverage = Math.max(1, Math.round(lev));
      lives[idx] = t; setLives(lives);
      showModal(el("editLiveModal"), false);
      renderLive(); toast("Live trade updated");
    });
    el("cancelEdit").addEventListener("click", ()=> showModal(el("editLiveModal"), false));

    /* ---------------- TPs ---------------- */
    function renderTpModal(){
      const t = getLives().find(x=>x.id===tpLiveId); if(!t) return;
      const remain = Math.max(0, 100 - (t.tpPct || 0));
      el("tpRemainHelp").textContent = `Remaining closable: ${remain.toFixed(2)}%`;
      const pctVal = parseFloat(el("tpPct").value);
      const priceVal = parseFloat(el("tpPrice").value);
      if(isFinite(pctVal) && isFinite(priceVal) && pctVal>0){
        const qtyClose = t.quantityBTC * (pctVal/100);
        const profitPreview = (priceVal - t.entryPrice) * qtyClose;
        const sign = profitPreview>=0 ? "+" : "";
        el("tpPreview").textContent = `Secured profit preview: ${sign}${fmt(profitPreview,2)} USDT (closes ${fmt(qtyClose,6)} BTC)`;
      }else{
        el("tpPreview").textContent = "Secured profit preview: ‚Äî";
      }
      const box = el("tpListBox"); box.innerHTML = "";
      if(!t.tpList || t.tpList.length===0){
        const empty = document.createElement("div"); empty.className = "muted"; empty.textContent = "No partial TPs yet. Add one above."; box.appendChild(empty);
      }else{
        t.tpList.forEach((tp, idx)=>{
          const row = document.createElement("div"); row.className = "hist-item";
          const sign = tp.profit>=0?"+":"";
          row.innerHTML = `<div class="muted"><b>${tp.pct}%</b> at <b>${fmt(tp.price,2)}</b> ‚Ä¢ qty: <b>${fmt(tp.qty,6)} BTC</b> ‚Ä¢ secured: <b>${sign}${fmt(tp.profit,2)} USDT</b> ‚Ä¢ ${new Date(tp.ts).toLocaleString()}</div>`;
          if(idx === t.tpList.length - 1){
            const undo = document.createElement("button"); undo.className = "btn ghost"; undo.textContent = "Undo last";
            undo.addEventListener("click", ()=>{
              const lives2 = getLives(); const t2 = lives2.find(x=>x.id===tpLiveId);
              const last = t2.tpList.pop();
              t2.quantityBTC = Number((t2.quantityBTC + last.qty).toFixed(6));
              t2.notionalUSDT = Number((t2.entryPrice * t2.quantityBTC).toFixed(2));
              t2.marginAmount = Number((t2.marginAmount / (1 - last.pct/100)).toFixed(2));
              t2.tpPct = Number((t2.tpPct - last.pct).toFixed(6));
              t2.tpSecured = Number((t2.tpSecured - last.profit).toFixed(2));
              let lev = t2.notionalUSDT / t2.marginAmount; t2.leverage = Math.max(1, Math.round(lev));
              setLives(lives2); renderTpModal(); renderLive();
            });
            row.appendChild(undo);
          }
          box.appendChild(row);
        });
        const total = document.createElement("div"); total.className="muted";
        const signT = (t.tpSecured||0) >= 0 ? "+" : "";
        total.textContent = `Total secured so far: ${signT}${fmt(t.tpSecured||0,2)} USDT`;
        box.appendChild(total);
      }
    }
    el("tpPct").addEventListener("input", renderTpModal);
    el("tpPrice").addEventListener("input", renderTpModal);
    el("cancelTp").addEventListener("click", ()=> showModal(el("tpModal"), false));
    el("applyTp").addEventListener("click", ()=>{
      const lives = getLives(); const t = lives.find(x=>x.id===tpLiveId);
      if(!t){ showModal(el("tpModal"), false); return; }
      const pct = parseFloat(el("tpPct").value);
      const price = parseFloat(el("tpPrice").value);
      if(!isFinite(pct) || pct<=0){ alert("Enter a valid percent to close."); return; }
      if(!isFinite(price) || price<=0){ alert("Enter a valid TP price."); return; }
      const remain = Math.max(0, 100 - (t.tpPct || 0));
      if(pct > remain - 0.001){ alert(`Percent too high. Remaining closable: ${remain.toFixed(2)}%`); return; }
      const qtyClose = t.quantityBTC * (pct/100);
      const profit = (price - t.entryPrice) * qtyClose;
      t.quantityBTC = Number((t.quantityBTC - qtyClose).toFixed(6));
      t.notionalUSDT = Number((t.entryPrice * t.quantityBTC).toFixed(2));
      t.marginAmount = Number((t.marginAmount * (1 - pct/100)).toFixed(2));
      t.tpPct = Number(((t.tpPct || 0) + pct).toFixed(6));
      t.tpSecured = Number(((t.tpSecured || 0) + profit).toFixed(2));
      t.tpList = t.tpList || [];
      t.tpList.push({ pct:Number(pct.toFixed(6)), price:Number(price.toFixed(2)), qty:Number(qtyClose.toFixed(6)), profit:Number(profit.toFixed(2)), ts: nowIso() });
      let lev = t.notionalUSDT / t.marginAmount; t.leverage = Math.max(1, Math.round(lev));
      setLives(lives);
      el("tpPct").value = ""; el("tpPrice").value = "";
      renderTpModal(); renderLive(); toast("TP applied");
    });

    /* ---------------- Render Live ---------------- */
    function renderLive(){
      const box = el("liveList"); box.innerHTML = "";
      const lives = getLives();
      if(lives.length===0){
        const ph = document.createElement("div"); ph.className="live-kv"; ph.textContent = "No trades in Live. Click ‚ÄúCalculate‚Äù, then ‚ÄúLive‚Äù to add (max 3)."; box.appendChild(ph); return;
      }
      lives.forEach(t=>{
        const card = document.createElement("div"); card.className = "live-card";
        const top = document.createElement("div"); top.className = "live-card-top";
        const left = document.createElement("div"); left.className = "live-id";
        left.innerHTML = `<span class="live-dot" style="width:10px;height:10px"></span><span class="badge">${t.pair} ${t.direction}</span>`;
        const right = document.createElement("div");
        const tpsBtn = document.createElement("button");
        tpsBtn.className = "btn tps" + ((t.tpList&&t.tpList.length)? " active": "");
        tpsBtn.textContent = "TPs"; tpsBtn.addEventListener("click", ()=>{ tpLiveId = t.id; showModal(el("tpModal"), true); renderTpModal(); });
        const editBtn = document.createElement("button");
        editBtn.className = "btn edit"; editBtn.textContent = "Edit"; editBtn.addEventListener("click", ()=>{ editingLiveId = t.id; showModal(el("editLiveModal"), true); el("editEntry").value=t.entryPrice; el("editStop").value=t.stopPrice; });
        const closeBtn = document.createElement("button");
        closeBtn.className = "btn close"; closeBtn.textContent = "Close Trade"; closeBtn.addEventListener("click", ()=>{ closingLiveId = t.id; showModal(el("closeModal"), true); });
        right.appendChild(tpsBtn); right.appendChild(editBtn); right.appendChild(closeBtn);
        top.appendChild(left); top.appendChild(right); card.appendChild(top);

        const body = document.createElement("div"); body.className = "live-kv";
        const opened = new Date(t.open_ts).toLocaleString();
        const secured = t.tpSecured || 0; const signS = secured>=0?"+":"";
        body.innerHTML = `
          <div><b>Opened</b> : ${opened}</div>
          <div><b>Entry</b> : ${fmt(t.entryPrice,2)} ‚Ä¢ <b>Stop</b> : ${fmt(t.stopPrice,2)}</div>
          <div><b>Size</b> : ${fmt(t.quantityBTC,6)} BTC ‚Ä¢ ${fmt(t.notionalUSDT,2)} USDT</div>
          <div><b>Margin</b> : ${fmt(t.marginAmount,2)} USDT ‚Ä¢ <b>Leverage</b> : ${t.leverage}x</div>
          ${ (t.tpList && t.tpList.length) ? `<div><b>P&amp;L (secured)</b>: ${signS}${fmt(secured,2)} USDT</div>`:"" }
        `;
        card.appendChild(body);
        box.appendChild(card);
      });
    }

    /* ---------------- History + Stats ---------------- */
    function renderStats(trades){
      const srEl = el("srStat"), plEl = el("plStat"), feesEl = el("feesStat");
      let totalPL = 0, totalFees = 0, wins = 0, losses = 0;
      trades.forEach(t=>{
        if(typeof t.netProfit === "number"){ totalPL += t.netProfit; if(t.netProfit > 0) wins++; if(t.netProfit < 0) losses++; }
        if(typeof t.totalFees === "number"){ totalFees += t.totalFees; }
      });
      const closed = wins + losses;
      srEl.textContent = closed>0 ? `${((wins/closed)*100).toFixed(2)}%` : "‚Äî";
      plEl.textContent = (totalPL >= 0 ? "+"+fmt(totalPL,2) : fmt(totalPL,2));
      plEl.classList.remove("pos","neg","zero");
      if(totalPL > 0) plEl.classList.add("pos"); else if(totalPL < 0) plEl.classList.add("neg"); else plEl.classList.add("zero");
      feesEl.textContent = fmt(totalFees,2);
    }
    function renderHistory(){
      const ul = el("historyList"); ul.innerHTML = "";
      const trades = getTrades();
      renderStats(trades);
      if(!Array.isArray(trades) || trades.length===0){
        const li=document.createElement("li"); li.className="hist-item"; li.innerHTML = '<span class="muted">No saved calculations.</span>'; ul.appendChild(li); return;
      }
      const sorted = trades.slice().reverse();
      sorted.forEach(trade=>{
        const li = document.createElement("li"); li.className="hist-item";
        const ts = new Date(trade.ts).toLocaleString();
        const header=document.createElement("div"); header.className="hist-top";
        const left=document.createElement("div");
        const extra = trade.outcome ? ` ‚Ä¢ ${trade.outcome}` : "";
        left.innerHTML = `<span class="pill">${trade.pair} ${trade.direction} [ ${ts} ]${extra}</span>`;
        const right=document.createElement("div");
        if(trade.tpList && trade.tpList.length){
          const viewBtn = document.createElement("button");
          viewBtn.className = "btn view"; viewBtn.textContent = "TPs";
          viewBtn.addEventListener("click", ()=>{
            const box = el("tpViewList"); box.innerHTML = "";
            trade.tpList.forEach(tp=>{
              const row = document.createElement("div"); row.className = "hist-item";
              const sign = tp.profit>=0?"+":"";
              row.innerHTML = `<div class="muted"><b>${tp.pct}%</b> at <b>${fmt(tp.price,2)}</b> ‚Ä¢ qty: <b>${fmt(tp.qty,6)} BTC</b> ‚Ä¢ secured: <b>${sign}${fmt(tp.profit,2)} USDT</b> ‚Ä¢ ${new Date(tp.ts).toLocaleString()}</div>`;
              box.appendChild(row);
            });
            showModal(el("tpViewModal"), true);
          });
          right.appendChild(viewBtn);
        }
        const del=document.createElement("button"); del.className="trash"; del.textContent="üóëÔ∏è";
        del.addEventListener("click", ()=>{
          if(!confirm("Delete this calculation?")) return;
          const cur=getTrades().filter(x=>x.id!==trade.id); setTrades(cur); renderHistory();
        });
        right.appendChild(del);
        header.appendChild(left); header.appendChild(right); li.appendChild(header);

        const body=document.createElement("div"); body.className="labels";
        const openLine = trade.open_ts ? `<div class="muted"><b>Opened</b>: ${new Date(trade.open_ts).toLocaleString()} ‚Ä¢ <b>Closed</b>: ${trade.close_ts? new Date(trade.close_ts).toLocaleString():"‚Äî"} ‚Ä¢ <b>Duration</b>: ${trade.duration || "‚Äî"}</div>` : "";
        const pnlLine  = (typeof trade.netProfit==="number" || typeof trade.totalFees==="number")
          ? `<div class="muted"><b>Net P/L</b>: <span class="pnl ${trade.netProfit>=0?"pos":"neg"}">${trade.netProfit>=0? "+"+fmt(trade.netProfit,2): fmt(trade.netProfit,2)}</span> ‚Ä¢ <b>Fees</b>: ${fmt(trade.totalFees??0,2)} USDT</div>` : "";
        body.innerHTML = `
          <div class="muted"><b>Wallet</b>: ${fmt(trade.wallet,2)} USDT ‚Ä¢ <b>Risk</b>: ${fmt(trade.riskPercent,2)}% ‚Ä¢ <b>Margin</b>: ${fmt(trade.marginPercent,2)}%</div>
          <div class="muted"><b>Entry</b>: ${fmt(trade.entryPrice,2)} ‚Ä¢ <b>Stop</b>: ${fmt(trade.stopPrice,2)}</div>
          <div class="muted"><b>Size</b>: ${fmt(trade.quantityBTC,6)} BTC ‚Ä¢ ${fmt(trade.notionalUSDT,2)} USDT ‚Ä¢ <b>Used margin</b>: ${fmt(trade.marginAmount,2)} USDT ‚Ä¢ <b>Leverage</b>: ${trade.leverage}x</div>
          ${openLine} ${pnlLine}
        `;
        li.appendChild(body); ul.appendChild(li);
      });
    }

    /* ---------------- Export ‚Üí Archive ---------------- */
    function showExportModal(show){ showModal(el("exportModal"), show); }
    el("exportBtn").addEventListener("click", ()=>{
      if(!isPro){ alert("Pro only. Redeem key in Profile."); return; }
      const trades = getTrades();
      if(!trades.length){ alert("No trades in History to export."); return; }
      showExportModal(true);
    });
    el("cancelExport").addEventListener("click", ()=> showExportModal(false));
    el("proceedExport").addEventListener("click", ()=>{
      const trades = getTrades(); const arch = getArchive();
      arch.push(...trades); setArchive(arch); setTrades([]); renderHistory(); showExportModal(false); toast("Exported to Archive");
    });

    /* ---------------- Archive browser ---------------- */
    const archState = { year:null, month:null, deleteId:null };
    function showArchiveModal(show){
      if(!isPro){ alert("Pro only. Redeem key in Profile."); return; }
      showModal(el("archiveModal"), show);
      if(show){ buildArchiveYears(); buildMonthGrid(); renderArchiveMonth(); }
      else { archState.year=null; archState.month=null; el("archiveList").innerHTML=""; el("archiveStats").style.display="none"; }
    }
    el("openArchive").addEventListener("click", ()=> showArchiveModal(true));
    el("closeArchive").addEventListener("click", ()=> showArchiveModal(false));
    function buildArchiveYears(){
      const arch = getArchive();
      const years = [...new Set(arch.map(t => new Date(t.close_ts || t.ts).getFullYear()))].filter(y=>!isNaN(y)).sort((a,b)=>b-a);
      const sel = el("yearSelect"); sel.innerHTML = "";
      if(years.length===0){ const opt=document.createElement("option"); opt.value=""; opt.textContent="‚Äî"; sel.appendChild(opt); archState.year=null; return; }
      years.forEach(y=>{ const opt=document.createElement("option"); opt.value=String(y); opt.textContent=String(y); sel.appendChild(opt); });
      archState.year = archState.year || String(years[0]); sel.value = archState.year;
      sel.onchange = ()=>{ archState.year = sel.value; buildMonthGrid(); renderArchiveMonth(); };
    }
    function monthNames(){ return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; }
    function buildMonthGrid(){
      const grid = el("monthGrid"); grid.innerHTML = "";
      const year = archState.year;
      const arch = getArchive().filter(t => new Date(t.close_ts || t.ts).getFullYear() == year);
      const counts = Array(12).fill(0);
      arch.forEach(t=> counts[new Date(t.close_ts || t.ts).getMonth()]++);
      monthNames().forEach((name, i)=>{
        const b = document.createElement("button"); b.className="m-btn"; b.textContent = name;
        const span = document.createElement("span"); span.className="m-count"; span.textContent = counts[i] ? ` (${counts[i]})` : "";
        b.appendChild(span);
        if(!counts[i]) b.disabled = true;
        if(archState.month===i) b.classList.add("active");
        b.addEventListener("click", ()=>{ archState.month = i; renderArchiveMonth(); buildMonthGrid(); });
        grid.appendChild(b);
      });
    }
    function renderArchiveMonth(){
      const list = el("archiveList"); list.innerHTML = "";
      const statsBox = el("archiveStats"); statsBox.style.display="none";
      const year = archState.year, month = archState.month;
      if(year===null || month===null){ list.innerHTML = `<div class="muted">Pick a month.</div>`; return; }
      const arch = getArchive().filter(t=>{
        const d = new Date(t.close_ts || t.ts); return d.getFullYear() == year && d.getMonth() == month;
      }).sort((a,b)=> new Date(b.ts) - new Date(a.ts));
      if(!arch.length){ list.innerHTML = `<div class="muted">No trades for this month.</div>`; return; }
      // Stats
      let wins=0, losses=0, pnl=0; arch.forEach(t=>{ if(typeof t.netProfit==="number"){ pnl += t.netProfit; if(t.netProfit>0) wins++; else if(t.netProfit<0) losses++; }});
      const closed = wins+losses;
      el("archSR").textContent = closed? ((wins/closed)*100).toFixed(2)+"%" : "‚Äî";
      el("archPL").textContent = pnl>=0? "+"+fmt(pnl,2): fmt(pnl,2);
      const firstWallet = arch[arch.length-1]?.wallet || 0;
      el("archGrowth").textContent = firstWallet>0? ((pnl/firstWallet)*100).toFixed(2)+"%":"‚Äî";
      statsBox.style.display="flex";

      arch.forEach(trade=>{
        const li = document.createElement("div"); li.className="hist-item";
        const ts = new Date(trade.ts).toLocaleString();
        const header=document.createElement("div"); header.className="hist-top";
        const left=document.createElement("div");
        const extra = trade.outcome ? ` ‚Ä¢ ${trade.outcome}` : "";
        left.innerHTML = `<span class="pill">${trade.pair} ${trade.direction} [ ${ts} ]${extra}</span>`;
        const right=document.createElement("div");
        if(trade.tpList && trade.tpList.length){
          const viewBtn = document.createElement("button"); viewBtn.className = "btn view"; viewBtn.textContent = "TPs";
          viewBtn.addEventListener("click", ()=>{
            const box = el("tpViewList"); box.innerHTML = "";
            trade.tpList.forEach(tp=>{
              const row = document.createElement("div"); row.className = "hist-item";
              const sign = tp.profit>=0?"+":"";
              row.innerHTML = `<div class="muted"><b>${tp.pct}%</b> at <b>${fmt(tp.price,2)}</b> ‚Ä¢ qty: <b>${fmt(tp.qty,6)} BTC</b> ‚Ä¢ secured: <b>${sign}${fmt(tp.profit,2)} USDT</b> ‚Ä¢ ${new Date(tp.ts).toLocaleString()}</div>`;
              box.appendChild(row);
            });
            showModal(el("tpViewModal"), true);
          });
          right.appendChild(viewBtn);
        }
        const del=document.createElement("button"); del.className="trash"; del.textContent="üóëÔ∏è";
        del.addEventListener("click", ()=>{ archState.deleteId = trade.id; showModal(el("archDel1"), true); });
        right.appendChild(del);
        header.appendChild(left); header.appendChild(right); li.appendChild(header);

        const body=document.createElement("div"); body.className="labels";
        const openLine = trade.open_ts ? `<div class="muted"><b>Opened</b>: ${new Date(trade.open_ts).toLocaleString()} ‚Ä¢ <b>Closed</b>: ${trade.close_ts? new Date(trade.close_ts).toLocaleString():"‚Äî"} ‚Ä¢ <b>Duration</b>: ${trade.duration || "‚Äî"}</div>` : "";
        const pnlLine  = (typeof trade.netProfit==="number" || typeof trade.totalFees==="number")
          ? `<div class="muted"><b>Net P/L</b>: <span class="pnl ${trade.netProfit>=0?"pos":"neg"}">${trade.netProfit>=0? "+"+fmt(trade.netProfit,2): fmt(trade.netProfit,2)}</span> ‚Ä¢ <b>Fees</b>: ${fmt(trade.totalFees??0,2)} USDT</div>` : "";
        body.innerHTML = `
          <div class="muted"><b>Wallet</b>: ${fmt(trade.wallet,2)} USDT ‚Ä¢ <b>Risk</b>: ${fmt(trade.riskPercent,2)}% ‚Ä¢ <b>Margin</b>: ${fmt(trade.marginPercent,2)}%</div>
          <div class="muted"><b>Entry</b>: ${fmt(trade.entryPrice,2)} ‚Ä¢ <b>Stop</b>: ${fmt(trade.stopPrice,2)}</div>
          <div class="muted"><b>Size</b>: ${fmt(trade.quantityBTC,6)} BTC ‚Ä¢ ${fmt(trade.notionalUSDT,2)} USDT ‚Ä¢ <b>Used margin</b>: ${fmt(trade.marginAmount,2)} USDT ‚Ä¢ <b>Leverage</b>: ${trade.leverage}x</div>
          ${openLine} ${pnlLine}
        `;
        li.appendChild(body); list.appendChild(li);
      });
    }

    // Archive delete flow
    el("archDel1Cancel").addEventListener("click", ()=> showModal(el("archDel1"), false));
    el("archDel1Yes").addEventListener("click", ()=>{ showModal(el("archDel1"), false); showModal(el("archDel2"), true); });
    el("archDel2Cancel").addEventListener("click", ()=>{ archState.deleteId=null; showModal(el("archDel2"), false); });
    el("archDel2Delete").addEventListener("click", ()=>{
      if(!archState.deleteId){ showModal(el("archDel2"), false); return; }
      let arch = getArchive(); arch = arch.filter(t=>t.id!==archState.deleteId); setArchive(arch); archState.deleteId = null;
      showModal(el("archDel2"), false); showModal(el("archDelOk"), true);
      buildArchiveYears(); buildMonthGrid(); renderArchiveMonth();
    });
    el("archDelOkClose").addEventListener("click", ()=> showModal(el("archDelOk"), false));
    el("closeTpView").addEventListener("click", ()=> showModal(el("tpViewModal"), false));

    /* ---------------- Auth state + Cloud sync ---------------- */
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ showAuth(true); return; }
      showAuth(false);
      el('accountEmail') && (el('accountEmail').textContent = user.email||user.uid);
      setPlanBadge();

      Cloud.uid=user.uid;
      Cloud.docRef=db.doc(`users/${user.uid}/state/app`);
      const snap=await Cloud.docRef.get();
      if(!snap.exists){
        await Cloud.docRef.set({pairs:[],live:[],trades:[],archive:[],updatedAt:Date.now()});
      }else{
        const d=snap.data();
        localStorage.setItem(PAIRS_KEY,JSON.stringify(d.pairs||[]));
        localStorage.setItem(LIVE_KEY,JSON.stringify(d.live||[]));
        localStorage.setItem(TRADES_KEY,JSON.stringify(d.trades||[]));
        localStorage.setItem(ARCHIVE_KEY,JSON.stringify(d.archive||[]));
      }
      Cloud.docRef.onSnapshot(s=>{
        if(!s.exists) return; const d=s.data();
        localStorage.setItem(PAIRS_KEY,JSON.stringify(d.pairs||[]));
        localStorage.setItem(LIVE_KEY,JSON.stringify(d.live||[]));
        localStorage.setItem(TRADES_KEY,JSON.stringify(d.trades||[]));
        localStorage.setItem(ARCHIVE_KEY,JSON.stringify(d.archive||[]));
        renderLive(); renderHistory();
      });

      await loadMeta(user.uid);
      await loadSubscription(user.uid);
      updateUiForPlan();
      renderLive(); renderHistory();
    });

  </script>
</body>
</html>
